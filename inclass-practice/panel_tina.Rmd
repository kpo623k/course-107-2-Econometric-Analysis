---
title: "panel_tina"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(tidyverse)
library(magrittr)
```

```{r}
library(readr)
fatality <- read_csv("https://raw.githubusercontent.com/tpemartin/Econometric-Analysis/master/Part%20II/fatality.csv")
#state:i
#i=1一組，i=4一組.....
#year:t
#變數有無下標it由data判斷，電腦不會主動告知
```

```{r}
library(plm)
```

```{r}
class(fatality)
#原本資料為dataframe，但dataframe沒有panel的概念，故要改變其類別
```

```{r}
pdf_fatality<-pdata.frame(fatality,c("state","year"))
#放入兩個變數名稱，第一個"state"為i，第二個"year"為t
```

```{r}
class(pdf_fatality)
#class要出現pdata.frame才可正確使用plm套件中的固定效果模型等等
```

```{r}
#各州啤酒稅（beertax）與車禍死亡率（mrall）
library(dplyr)
library(ggplot2)
fatality %>% 
  ggplot()+
  geom_point(aes(x=beertax,y=I(mrall*1000)))
#ggplot2:形成canvas(畫布)
#"+"：加上層疊的圖形，以geom作開頭
#aes：函數位置，X軸:data,Y軸:用I作變數值直接轉換；mutate(創造新變數)之概念
```

```{r}
#把美學color="blue"放在aes外面
library(dplyr)
library(ggplot2)
fatality %>% 
  ggplot()+
  geom_point(aes(x=beertax,y=I(mrall*1000)),color="blue")
```

```{r}
#把美學color="blue"放在aes裡面
library(dplyr)
library(ggplot2)
fatality %>% 
  ggplot()+
  geom_point(aes(x=beertax,y=I(mrall*1000),color="blue"))
             
```

```{r} 
#用顏色區分不同的州
#?ggplot ~美感
#stroke：圈，fill：圈裡面的填滿
fatality %>% 
  ggplot()+
  geom_point(aes(x=beertax,y=I(mrall*1000),color=state))
```

```{r}
fatality$state %>% class
```

```{r}
library(dplyr)
library(ggplot2)
fatality %>% 
  ggplot()+
  geom_point(aes(x=beertax,y=I(mrall*1000),color=as.factor("state")))
```

```{r}
fatality %>% 
  ggplot()+
  geom_point(aes(x=beertax,y=I(mrall*1000),color=year))
```

```{r}
#組內差異，進行demean
fatality %>% 
  group_by(state) %>% #依state分組進行以下程序：
  mutate(
    mrall_demean=mrall-mean(mrall),
    beertax_demean=beertax-mean(beertax)
    ) %>%
  select(mrall_demean,beertax_demean,state) %>%
  ungroup() -> demean_results # grouping variable會被保留

```

```{r}
demean_results %>%
  ggplot()+
  geom_point(aes(x=beertax_demean,y=mrall_demean,color=as.factor(state)))+
  geom_smooth(aes(x=beertax_demean,y=mrall_demean),method = "lm",se=FALSE)
#se：standard error，TRUE:95%信賴區間，其中TRUE或FALSE是全大寫
```

```{r}
fatality %>% lm(data=., mrall~factor(state)) -> results
# results$residuals 也會是demean的結果
```

# 資料分析流程
## 確定變數class
```{r}
fatality %>% 
  mutate(state=as.factor(state),year=as.orered(year)) -> fatality
#用mutate修正class，並存下來
#之後再開始作圖及資料分析，這樣就不用在過程中一直處理轉換class的問題
```

##作圖

##資料分析
```{r}
ls(mrall~beetrax+state, date=fatality)
```


```{r}
model<-mrall~beertax
```

## plm

```{r}
pool1<-plm(model, data=fatality, model='pooling')
summary(pool1)
```


```{r}
re1<-plm(model, data=fatality, model='random')
summary(re1)
```

```{r}
fe1<-plm(model, data=fatality, model='within', effect='individual')
summary(fe1)
```

```{r}
fe2<-plm(model, data=fatality, model='within', effect='twoways')
summary(fe2)
```

```{r, results="asis"}
library(stargazer)
stargazer(pool1,re1,fe1,fe2,type='html',
          column.labels = c("Pooled OLS","RE","FE-individual","FE-two-ways"))
#用stargazer作模型比較
```

```{r}
phtest(fe1,re1)
#在虛無假設(H_0)下，V_it與beertax_it無關 -> 可用FE、RE
#在對立假設(H_1)下 -> 只可用 FE?
```

```{r}
fatality %>%
  plm(mrall~beertax+unrate, data=., method="within",effect = "individual")
```












